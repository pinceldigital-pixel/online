<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radio · Minimal Dark</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0b0c">
  <link rel="icon" href="assets/icon-192.png" sizes="192x192">
  <style>
    :root{ --bg:#0b0b0c; --card:#141416; --text:#f2f2f2; --muted:#9aa0a6; --accent:#ff7a00; --accent-weak:#ff7a0044; --glass:rgba(255,255,255,0.05); }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text); display:flex; flex-direction:column;}
    header{ display:flex; align-items:center; justify-content:space-between; padding:18px 16px 8px; }
    .title{ letter-spacing:.22em; font-weight:700; opacity:.95 }
    .moon{ width:44px; height:44px; cursor:pointer; border-radius:999px; background:var(--card); display:grid; place-items:center; position:relative; overflow:hidden; box-shadow: 0 0 0 1px #1c1d20 inset, 0 6px 22px rgba(0,0,0,.55), 0 0 12px rgba(255,255,255,.03); }
    .moon svg{display:block}
    .moon.active svg path{stroke:var(--accent)!important; fill:var(--accent)!important; opacity:1!important;}
    main{ display:flex; flex-direction:column; gap:10px }
    .now{ margin:10px 16px 8px; background:var(--glass); border-radius:22px; padding:18px; display:flex; align-items:center; justify-content:space-between; gap:10px; box-shadow: 0 1px 0 #1c1d20 inset, 0 10px 24px rgba(0,0,0,.3); }
    .nowContent{ display:flex; flex-direction:column; gap:6px; min-width:0 }
    .nowFreq{ font-size:30px; font-weight:800; letter-spacing:.02em }
    .nowLabel{ font-size:16px; color:var(--muted); font-weight:700; letter-spacing:.08em; text-transform:uppercase }
    .onair-chip{ display:flex; align-items:center; gap:8px; padding:8px 14px; width:max-content; background:#15161a; border:1px solid #23262d; border-radius:999px; letter-spacing:.08em; font-weight:700 }
    .onair-chip .dot{ width:10px; height:10px; background:var(--accent); border-radius:50%; box-shadow:0 0 0 0 var(--accent-weak); animation:pulse 1.8s infinite }
    @keyframes pulse{ 0%{ box-shadow:0 0 0 0 var(--accent-weak)} 70%{ box-shadow:0 0 0 12px transparent} 100%{ box-shadow:0 0 0 0 transparent} }
    .nowTrack{ font-style:italic; color:#c9c9c9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100% }
    .eq{ display:flex; align-items:flex-end; gap:3px; height:22px }
    .bar{ width:3px; background:var(--accent); height:4px; border-radius:2px }
    .stations{ display:grid; gap:14px; padding:8px 16px 16px; grid-template-columns:repeat(2,1fr) }
    .btn{ background:var(--card); border:none; color:var(--text); border-radius:22px; height:118px; padding:0 18px; display:flex; align-items:center; justify-content:center; box-shadow: 0 1px 0 #1c1d20 inset, 0 10px 24px rgba(0,0,0,.4); }
    .cardText{ display:flex; flex-direction:column; align-items:center; gap:6px }
    .cardText .freq{ font-size:28px; font-weight:800; letter-spacing:.02em }
    .cardText .label{ font-size:14px; color:var(--muted); font-weight:700; letter-spacing:.08em; text-transform:uppercase }
    .mini{ position:fixed; left:12px; right:12px; bottom:12px; background:var(--card); border-radius:16px; padding:12px 14px; box-shadow: 0 10px 30px rgba(0,0,0,.45); }
    .controls{ display:flex; align-items:center; gap:10px; justify-content:center }
    .icon-btn{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; background:#1b1c1f; border:none; color:#fff; cursor:pointer }
    footer{ height:16px }
    .toast{ position:fixed; right:14px; bottom:80px; background:#16171a; color:#fff; padding:10px 12px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.4); opacity:0; transform:translateY(10px); transition: all .25s ease; pointer-events:none; border:1px solid #22242a; }
    .toast.show{opacity:1; transform:translateY(0)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="title">RADIO</div>
    <button id="sleepBtn" class="moon" title="Temporizador 30 min">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M21 14.5A9 9 0 0 1 9.5 3a7.8 7.8 0 1 0 11.5 11.5Z" stroke="#cfcfcf" stroke-width="1.3" fill="#ffffff22" opacity=".9"/>
      </svg>
    </button>
  </header>

  <main>
    <div class="now">
      <div class="nowContent">
        <div id="nowFreq" class="nowFreq">—</div>
        <div id="stationLabel" class="nowLabel">Elegí una estación</div>
        <div id="onAirChip" class="onair-chip hidden"><span class="dot"></span><span>ON AIR</span></div>
        <div id="track" class="nowTrack">—</div>
      </div>
      <div class="eq" aria-hidden="true">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
    </div>

    <div id="stations" class="stations"></div>
  </main>

  <div class="mini">
    <div class="controls">
      <button id="prevBtn" class="icon-btn" aria-label="Prev">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#ffffff" d="M6 6h2v12H6zm3 6l9 6V6z"/></svg>
      </button>
      <button id="playPause" class="icon-btn" aria-label="Play/Pause">
        <svg id="ppPlay" class="ppicon" width="22" height="22" viewBox="0 0 24 24"><path fill="#ffffff" d="M8 5v14l11-7z"/></svg>
        <svg id="ppPause" class="ppicon hidden" width="22" height="22" viewBox="0 0 24 24"><path fill="#ffffff" d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>
      </button>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="1" style="width:140px">
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <audio id="player" crossorigin="anonymous"></audio>

  <script>
  const STATIONS = [
    { id:'now',   label:'Now',  freq:'97.9',  name:'Now 97.9',  url:'https://ipanel.instream.audio:7002/stream', meta:{} },
    { id:'blue',  label:'Blue', freq:'100.7', name:'Blue 100.7',url:'https://27693.live.streamtheworld.com/BLUE_FM_100_7AAC.aac', meta:{ tmwId:'BLUE_FM_100_7' } },
    { id:'aspen', label:'Aspen',freq:'102.3', name:'Aspen 102.3',url:'https://playerservices.streamtheworld.com/api/livestream-redirect/ASPEN.mp3', meta:{ tmwId:'ASPEN' } },
    { id:'lnp',   label:'LN+',  freq:'104.9', name:'LN+ 104.9', url:'https://stream.radio.co/s2ed3bec0a/listen', meta:{} },
  ];

  const stationsEl = document.getElementById('stations');
  const player = document.getElementById('player');
  const playPause = document.getElementById('playPause');
  const ppPlay = document.getElementById('ppPlay');
  const ppPause = document.getElementById('ppPause');
  const prevBtn = document.getElementById('prevBtn');
  const vol = document.getElementById('vol');
  const trackEl = document.getElementById('track');
  const stationLabel = document.getElementById('stationLabel');
  const nowFreq = document.getElementById('nowFreq');
  const toast = document.getElementById('toast');
  const sleepBtn = document.getElementById('sleepBtn');
  const onAirChip = document.getElementById('onAirChip');
  let current = null, index = 0;
  let context, analyser, dataArray, rafId;
  let sleepTimer=null, sleepRemaining=0; const SLEEP_TOTAL=30*60;

  function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200); }

  function buildStations(){
    stationsEl.innerHTML='';
    STATIONS.forEach(s=>{
      const btn = document.createElement('button');
      btn.className='btn';
      btn.dataset.id = s.id;
      btn.innerHTML = `<div class="cardText"><div class="freq">${s.freq}</div><div class="label">${s.label}</div></div>`;
      btn.addEventListener('click', ()=> playStation(s));
      stationsEl.appendChild(btn);
    });
  }

  async function fetchStreamTheWorldNowPlaying(id){
    const endpoints=[
      `https://np.tritondigital.com/public/nowplaying?mountName=${encodeURIComponent(id)}&numberOfTracks=1&eventType=track`,
      `https://playerservices.streamtheworld.com/api/livestream-redirect/${encodeURIComponent(id)}_SC`
    ];
    for (const url of endpoints){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if (!res.ok) continue;
        const ct = res.headers.get('content-type')||'';
        if (ct.includes('application/json')){
          const j = await res.json();
          const t = j?.nowplaying?.track?.song || j?.song || j?.title;
          if (t) return t;
        } else {
          const txt = await res.text();
          const m = txt.match(/StreamTitle='([^']+)'/);
          if (m) return m[1];
        }
      }catch(e){}
    }
    return null;
  }

  async function updateMetadata(){
    let title=null;
    if (current?.meta?.tmwId){ title = await fetchStreamTheWorldNowPlaying(current.meta.tmwId); }
    if (!title && 'mediaSession' in navigator){
      const md = navigator.mediaSession.metadata;
      if (md && (md.title || md.artist)){ title = [md.title, md.artist].filter(Boolean).join(' — '); }
    }
    trackEl.textContent = title || 'Reproduciendo…';
    trackEl.style.opacity = title ? 1 : .8;
  }

  async function playStation(s){
    current = s; index = STATIONS.findIndex(x=>x.id===s.id);
    player.src = s.url + (s.url.includes('?')?'&':'?') + 't=' + Date.now();
    player.play().catch(()=>{});
    ppPlay.classList.add('hidden'); ppPause.classList.remove('hidden');
    stationLabel.textContent = s.label; nowFreq.textContent = s.freq;
    onAirChip.classList.remove('hidden');
    trackEl.textContent = 'Cargando…';
    showToast('Reproduciendo ' + s.name);
    updateMetadata();
    if (!context) initAnalyser();
  }

  function initAnalyser(){
    try{
      context = new (window.AudioContext||window.webkitAudioContext)();
      const source = context.createMediaElementSource(player);
      analyser = context.createAnalyser(); analyser.fftSize = 256;
      source.connect(analyser); analyser.connect(context.destination);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      animateEq();
    }catch(e){}
  }

  function animateEq(){
    const bars = document.querySelectorAll('.bar'); const len = bars.length;
    const step = ()=>{
      if (analyser){ analyser.getByteFrequencyData(dataArray);
        for(let i=0;i<len;i++){ const idx=(i*2+5)|0; const v=dataArray[idx]||0; const h=4+(v/255)*18; bars[i].style.height=h+'px'; }
      } else { const t=Date.now()/200; for(let i=0;i<len;i++){ const h=4+(Math.sin(t+i)*.5+.5)*18; bars[i].style.height=h+'px'; } }
      rafId = requestAnimationFrame(step);
    }; step();
  }

  // Controls
  playPause.addEventListener('click', ()=>{
    if (player.paused){ player.play(); ppPlay.classList.add('hidden'); ppPause.classList.remove('hidden'); }
    else { player.pause(); ppPause.classList.add('hidden'); ppPlay.classList.remove('hidden'); }
  });
  prevBtn.addEventListener('click', ()=>{ index=(index-1+STATIONS.length)%STATIONS.length; playStation(STATIONS[index]); });
  vol.addEventListener('input', ()=>{ player.volume = parseFloat(vol.value||'1'); });
  player.addEventListener('playing', updateMetadata);
  setInterval(()=>{ if(!player.paused) updateMetadata(); }, 15000);

  // Sleep timer (moon): toggles orange fill when active
  function startSleep(){
    sleepRemaining = SLEEP_TOTAL; sleepBtn.classList.add('active');
    if (sleepTimer) clearInterval(sleepTimer);
    sleepTimer = setInterval(()=>{
      sleepRemaining -= 1;
      if (sleepRemaining<=0){ clearInterval(sleepTimer); sleepTimer=null; player.pause(); ppPause.classList.add('hidden'); ppPlay.classList.remove('hidden'); sleepBtn.classList.remove('active'); showToast('Temporizador: fin'); }
    }, 1000);
    showToast('Temporizador: 30 min');
  }
  function stopSleep(){ if(sleepTimer){ clearInterval(sleepTimer); sleepTimer=null; } sleepBtn.classList.remove('active'); showToast('Temporizador cancelado'); }
  sleepBtn.addEventListener('click', ()=>{ if(sleepTimer) stopSleep(); else startSleep(); });

  // Build UI
  buildStations();
  </script>
</body>
</html>
