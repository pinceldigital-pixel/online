<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Radio Dial</title>
<link href="manifest.json" rel="manifest"/>
<meta content="#111111" name="theme-color"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root {
            --bg-color: #111111;
            --text-color: #ffffff;
            --text-secondary: #aaaaaa;
            --accent-red: #ff3b3b;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 12px 20px 20px;
            max-width: 400px;
            height: 100vh;
            margin: auto;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
            text-align: center;
        }
        .radio-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            flex-grow: 1;
        }
        .header { 
            margin-bottom: 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .on-air-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .on-air-dot {
            width: 16px;
            height: 16px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-2px);
        }
        .on-air-dot.pulsing {
            background-color: var(--accent-red);
            animation: pulse 1.5s infinite ease-in-out;
        }
        .on-air-text {
            font-size: 1.5rem;
            line-height: 1;
            font-weight: 900;
            color: var(--text-secondary);
            letter-spacing: 1px;
            transition: color 0.3s;
        }
        .on-air-text.playing { color: var(--accent-red); }
        .timer-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        .timer-btn svg {
            width: 28px;
            height: 28px;
            stroke: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .timer-btn.active svg {
            stroke: var(--accent-red);
            fill: var(--accent-red);
        }
        
        .station-info { margin-bottom: 0px; }
        #station-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
            text-transform: uppercase;
        }
        #station-frequency {
            font-size: 6rem;
            font-weight: 900;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.1;
        }
        #station-frequency .mhz {
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 5px;
        }
        
        #now-playing-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 5px;
            margin-bottom: 25px;
            height: 20px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .tuner {
            position: relative;
            height: 70px;
            width: 100%;
            margin-bottom: 40px;
            overflow: hidden;
        }
        .tuner-scale {
            position: relative;
            width: 100%;
            height: 50px;
            background-image: repeating-linear-gradient(to right, var(--text-secondary) 1px, transparent 1px, transparent 1.11%);
            background-size: 100% 50%;
            background-repeat: repeat-x;
            background-position: center 100%;
            opacity: 0.3;
        }
        .tuner-mark {
            position: absolute;
            bottom: 0;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transform: translateX(-50%);
        }
        .tuner-mark::before {
            content: '';
            width: 2px;
            height: 25px;
            background-color: var(--text-color);
            margin-top: 4px;
            opacity: 0.7;
        }
        .tuner-indicator {
            position: absolute;
            width: 3px;
            height: 70px;
            background-color: var(--accent-red);
            box-shadow: 0 0 8px var(--accent-red);
            border-radius: 2px;
            z-index: 10;
            left: 10%; 
            transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* --- CAMBIO 1: Distribuimos los controles --- */
        .controls {
            display: flex;
            justify-content: space-between; /* <- CORRECCIÓN: space-between */
            align-items: center;
            /* gap: 30px; (Ya no es necesario) */
            width: 100%;
            padding: 20px 0;
        }
        .control-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        #play-pause-btn {
            background: none; 
            border: 2px solid var(--text-secondary); 
            color: var(--text-secondary); 
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 2rem;
            display: flex;
            /* --- CAMBIO 2: Centramos el ícono (||) --- */
            justify-content: center; /* <- CORRECCIÓN: center */
            align-items: center;
            transition: color 0.1s, border-color 0.1s; 
        }
        #play-pause-btn:active {
            background-color: transparent; 
            color: var(--accent-red); 
            border-color: var(--accent-red); 
        }
        
        #audio-player { display: none; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 59, 59, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(255, 59, 59, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 59, 59, 0); }
        }
    
/* --- Visualizer (auto-inserted) --- */
.visualizer{
  width:100%;
  height:70px;
  min-height:70px;
  margin: 12px 0 20px;
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px;
  overflow: hidden;
}
#viz{
  width:100%;
  height:100%;
  display:block;
}
/* --- /Visualizer --- */

/* --- Visualizer (relocated) --- */
.visualizer{
  width:100%;
  height:70px;
  min-height:70px;
  margin: 8px 0 14px;
  background: #000;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  overflow: hidden;
}
#viz{ width:100%; height:100%; display:block; }
/* --- /Visualizer --- */

/* --- Visualizer (ajustada) --- */
.visualizer{
  width:100%;
  height:70px;
  min-height:70px;
  margin: -2px 0 12px; /* subí un poco las barras */
  background: #111111;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  overflow: hidden;
}
#viz{ width:100%; height:100%; display:block; }
/* --- /Visualizer --- */

/* --- Visualizer (full #111111) --- */
.visualizer{
  width:100%;
  height:70px;
  min-height:70px;
  margin: -2px 0 12px;
  background: #111111;
  border: none;
  border-radius: 0;
  overflow: hidden;
}
#viz{
  width:100%;
  height:100%;
  display:block;
}
/* --- /Visualizer --- */
</style>
</head>
<body>
<audio id="audio-player" preload="none"></audio>
<div class="radio-container">
<header class="header">
<div class="on-air-status">
<span class="on-air-dot" id="on-air-dot"></span>
<span class="on-air-text" id="on-air-text">OFF AIR</span>
</div>
<button aria-label="Temporizador de apagado" class="timer-btn" id="sleep-timer-btn">
<svg fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
</svg>
</button>
</header>
<main class="station-info">
<h2 id="station-name">Club 80s</h2>
<h1 id="station-frequency">80s</h1>
</main>
<p id="now-playing-title"></p>
<div class="tuner">
<div class="tuner-indicator" id="tuner-indicator"></div>
<div class="tuner-scale" id="tuner-scale"></div>
</div>
</div>
<div class="visualizer"><canvas height="70" id="viz" width="360"></canvas></div><footer class="controls">
<button class="control-btn" id="prev-btn"><i class="fa-solid fa-backward-step"></i></button>
<button class="control-btn" id="play-pause-btn"><i class="fa-solid fa-play" id="play-pause-icon"></i></button>
<button class="control-btn" id="next-btn"><i class="fa-solid fa-forward-step"></i></button>
</footer>
<script>
        // (El JavaScript no necesita ningún cambio)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registrado.', reg))
                    .catch(err => console.error('Error al registrar Service Worker:', err));
            });
        }
    
        const stations = [
            { name: "Club 80s", freq: "80s", url: "https://stream.radioclub80.cl:8002/clasicos80.mp3" },
            { name: "Power 90s", freq: "90s", url: "https://live.powerhitz.com/90sarea" },
            { name: "2000s Hits", freq: "00s", url: "https://streaming.live365.com/a48930" },
            { name: "Blue", freq: "100.7", url: "https://27693.live.streamtheworld.com/BLUE_FM_100_7AAC.aac" },
            { name: "Aspen", freq: "102.3", url: "https://playerservices.streamtheworld.com/api/livestream-redirect/ASPEN.mp3" },
            { name: "LN+", freq: "104.9", url: "https://stream.radio.co/s2ed3bec0a/listen" }
        ];

        const MIN_FREQ = 97.0;
        const MAX_FREQ = 106.0;

        let currentStationIndex = 0;
        let isPlaying = false;
        let sleepTimer = null;

        const audioPlayer = document.getElementById('audio-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const stationNameEl = document.getElementById('station-name');
        const stationFrequencyEl = document.getElementById('station-frequency');
        const onAirDot = document.getElementById('on-air-dot');
        const onAirText = document.getElementById('on-air-text');
        const nowPlayingTitle = document.getElementById('now-playing-title');
        const sleepTimerBtn = document.getElementById('sleep-timer-btn');
        const tunerScale = document.getElementById('tuner-scale');
        const tunerIndicator = document.getElementById('tuner-indicator');

        function loadStation(index) {
            const station = stations[index];
            stationNameEl.textContent = station.name;
            audioPlayer.src = station.url;
            updateMediaSession(station);
            
            const freq = parseFloat(station.freq);
            
            if (!isNaN(freq)) {
                stationFrequencyEl.innerHTML = `${station.freq}<span class="mhz">MHz</span>`;
                const freqSpan = MAX_FREQ - MIN_FREQ;
                const percentPosition = (freq - MIN_FREQ) / freqSpan * 100;
                const clampedPosition = Math.max(0, Math.min(100, percentPosition)); 
                tunerIndicator.style.left = clampedPosition + '%';
            } else {
                stationFrequencyEl.innerHTML = station.freq;
                tunerIndicator.style.left = '0%'; 
            }
            
            if (isPlaying) {
                playAudio();
            }
        }

        function playAudio() {
            audioPlayer.play().then(() => {
                isPlaying = true;
                playPauseIcon.classList.remove('fa-play');
                playPauseIcon.classList.add('fa-pause');
                onAirText.textContent = 'ON AIR';
                onAirText.classList.add('playing');
                onAirDot.classList.add('pulsing');
                navigator.mediaSession.playbackState = 'playing';
            }).catch(error => console.error("Error al reproducir (autoplay bloqueado por navegador?):", error));
        }

        function pauseAudio() {
            audioPlayer.pause();
            isPlaying = false;
            playPauseIcon.classList.remove('fa-pause');
            playPauseIcon.classList.add('fa-play');
            onAirText.textContent = 'OFF AIR';
            onAirText.classList.remove('playing');
            onAirDot.classList.remove('pulsing');
            navigator.mediaSession.playbackState = 'paused';
            nowPlayingTitle.textContent = "";

            if (sleepTimer) {
                clearTimeout(sleepTimer);
                sleepTimer = null;
                sleepTimerBtn.classList.remove('active');
            }
        }

        function togglePlayPause() {
            if (isPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        }

        function nextStation() {
            currentStationIndex = (currentStationIndex + 1) % stations.length;
            loadStation(currentStationIndex);
        }

        function prevStation() {
            currentStationIndex = (currentStationIndex - 1 + stations.length) % stations.length;
            loadStation(currentStationIndex);
        }
        
        function toggleSleepTimer() {
            if (sleepTimer) {
                clearTimeout(sleepTimer);
                sleepTimer = null;
                sleepTimerBtn.classList.remove('active');
            } else {
                sleepTimerBtn.classList.add('active');
                const thirtyMinutes = 30 * 60 * 1000;
                sleepTimer = setTimeout(() => {
                    pauseAudio();
                    sleepTimer = null;
                    sleepTimerBtn.classList.remove('active');
                }, thirtyMinutes);
            }
        }
        
        function updateMediaSession(station) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: station.name,
                    artist: 'Radio en Vivo',
                    album: station.freq, 
                    artwork: [
                        { src: 'icon-192.png', sizes: '192x192', type: 'image/png' },
                        { src: 'icon-512.png', sizes: '512x512', type: 'image/png' },
                    ]
                });
                try {
                    navigator.mediaSession.addEventListener('metadata', () => {
                        const metadata = navigator.mediaSession.metadata;
                        if (metadata.title && metadata.title !== station.name) {
                            nowPlayingTitle.textContent = metadata.title;
                        } else if (metadata.artist && metadata.artist !== 'Radio enVivo') {
                            nowPlayingTitle.textContent = metadata.artist;
                        } else {
                            nowPlayingTitle.textContent = "";
                        }
                    });
                } catch (e) { console.warn("Listener de metadata falló", e); }
            }
        }
        
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', playAudio);
            navigator.mediaSession.setActionHandler('pause', pauseAudio);
            navigator.mediaSession.setActionHandler('previoustrack', prevStation);
            navigator.mediaSession.setActionHandler('nexttrack', nextStation);
        }

        function initTuner() {
            tunerScale.innerHTML = '';
            const freqSpan = MAX_FREQ - MIN_FREQ;

            for (let freq = Math.floor(MIN_FREQ); freq <= Math.ceil(MAX_FREQ); freq++) {
                const percentPosition = (freq - MIN_FREQ) / freqSpan * 100;
                
                const mark = document.createElement('div');
                mark.className = 'tuner-mark';
                mark.style.left = percentPosition + '%';
                
                const number = document.createElement('span');
                number.textContent = freq;
                mark.appendChild(number);
                
                tunerScale.appendChild(mark);
            }
        }

        playPauseBtn.addEventListener('click', togglePlayPause);
        nextBtn.addEventListener('click', nextStation);
        prevBtn.addEventListener('click', prevStation);
        sleepTimerBtn.addEventListener('click', toggleSleepTimer);

        initTuner();
        loadStation(currentStationIndex); 
        
        playAudio(); // Autoplay
    </script>
<script>
/* === Audio Visualizer (auto-inserted) === */
(function(){
  const audio = document.getElementById('audio-player');
  const canvas = document.getElementById('viz');
  if(!audio || !canvas) return; // no romper nada si no está
  try { audio.crossOrigin = "anonymous"; } catch(e){}
  const ctx = canvas.getContext('2d');
  let audioCtx = null, srcNode = null, analyser = null, raf = 0, drawViz = null, ready = false;
  const dpr = window.devicePixelRatio || 1;

  function resize(){
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(1, Math.floor(rect.width * dpr));
    canvas.height = Math.max(1, Math.floor(rect.height * dpr));
  }
  resize();
  window.addEventListener('resize', resize);

  function init(){
    if(ready) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    if(!audioCtx) audioCtx = new AC();
    if(!analyser){
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
    }
    if(!srcNode){
      try{
        srcNode = audioCtx.createMediaElementSource(audio);
        srcNode.connect(analyser);
        // No conectar a destination para evitar duplicación de audio
        // El audio ya sale por el <audio> element
      }catch(e){
        // Si ya estaba creado en otro script, ignorar
      }
    }
    ready = true;

    const bufferLength = analyser.frequencyBinCount;
    const data = new Uint8Array(bufferLength);

    drawViz = function(){
      raf = requestAnimationFrame(drawViz);
      analyser.getByteFrequencyData(data);
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);
      ctx.globalAlpha = 0.8;
      ctx.fillStyle = '#111111';
      ctx.fillRect(0,0,W,H);

      const bars = 40;
      const step = Math.max(1, Math.floor(data.length / bars));
      const barW = W / bars;
      for(let i=0;i<bars;i++){
        const v = data[i*step] / 255;
        const h = Math.max(2, v * (H*0.9));
        const x = i * barW + 2;
        const y = H - h;
        ctx.globalAlpha = 0.85;
        ctx.fillStyle = '#ff3b3b';
        ctx.fillRect(x, y, barW - 4, h);
        ctx.globalAlpha = 0.25;
        ctx.fillRect(x, y - 4, barW - 4, 4);
      }
      ctx.globalAlpha = 1;
    };
  }

  function start(){
    init();
    if(audioCtx && audioCtx.state === 'suspended'){
      audioCtx.resume();
    }
    if(ready && !raf && typeof drawViz === 'function'){
      drawViz();
    }
  }
  function stop(){
    if(raf){ cancelAnimationFrame(raf); raf = 0; }
  }

  audio.addEventListener('play', start);
  audio.addEventListener('pause', stop);
  audio.addEventListener('ended', stop);
})();
/* === /Audio Visualizer === */
</script></body>
</html>