<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radios · Minimal Dark</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0b0c">
  <link rel="icon" href="assets/icon-192.png" sizes="192x192">
  <style>
    :root{
      --bg:#0b0b0c;
      --card:#141416;
      --text:#f2f2f2;
      --muted:#9aa0a6;
      --accent:#ff7a00;
      --accent-weak:#ff7a0044;
      --glass:rgba(255,255,255,0.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';
      background:var(--bg);
      color:var(--text);
      display:flex; flex-direction:column; 
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 16px 8px;
    }
    .title{
      letter-spacing:.22em;
      font-weight:600; 
      color:var(--text);
      opacity:.95;
    }
    .moon{
      width:44px; height:44px; cursor:pointer; border-radius:999px; background:var(--card);
      display:grid; place-items:center; position:relative; overflow:visible;
      box-shadow: 0 0 0 1px #1c1d20 inset, 0 6px 22px rgba(0,0,0,.55), 0 0 12px rgba(255,255,255,.03);
    }
    .moon svg{display:block}
    .moon .ring{
      position:absolute; inset:-10px; pointer-events:none;
    }
    .ring circle{
      fill:none; stroke:var(--accent); stroke-width:3; opacity:.8;
      transform:rotate(-90deg); transform-origin:50% 50%;
      stroke-dasharray: 283; stroke-dashoffset: 283;
      transition:stroke-dashoffset .4s linear;
    }
    .moon.active{outline:2px solid var(--accent-weak)}
    .stations{display:grid; gap:12px; padding:8px 16px 12px}
    .btn{
      background:var(--card); border:none; color:var(--text); padding:18px 16px; border-radius:16px;
      text-align:left; font-size:18px; display:flex; align-items:center; justify-content:space-between;
      transition: transform .06s ease;
      box-shadow: 0 1px 0 #1c1d20 inset, 0 8px 18px rgba(0,0,0,.35);
    }
    .btn:active{ transform:scale(.99) }
    .left{display:flex; align-items:center; gap:12px}
    .onair{
      width:26px; height:26px; border-radius:999px; display:grid; place-items:center;
      background:var(--accent); box-shadow: 0 0 0 0 var(--accent-weak);
      animation:pulse 1.8s infinite;
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 var(--accent-weak)}
      70%{ box-shadow: 0 0 0 12px transparent}
      100%{ box-shadow: 0 0 0 0 transparent}
    }
    .onair svg{width:14px; height:14px; fill:#0b0b0c}
    .onair-top{display:flex; align-items:center; gap:8px; padding:8px 14px; margin:6px auto 6px; width:max-content; background:#15161a; border:1px solid #23262d; border-radius:999px; letter-spacing:.08em; font-weight:600}
    .onair-top.center{justify-content:center}
    .onair-top .dot{width:10px; height:10px; background:var(--accent); border-radius:50%; box-shadow:0 0 0 0 var(--accent-weak); animation:pulse 1.8s infinite}

    .onair-label{color:var(--accent); font-weight:600; letter-spacing:.06em}
    .chip{font-size:12px; color:var(--muted)}
    .now{
      margin:6px 16px 12px; background:var(--glass); border-radius:16px; padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 1px 0 #1c1d20 inset, 0 6px 16px rgba(0,0,0,.25);
    }
    .meta{min-width:0}
    .track{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .station{font-size:13px; color:var(--muted)}
    .mini{
      position:fixed; left:12px; right:12px; bottom:12px; background:var(--card); border-radius:16px; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    .controls{display:flex; align-items:center; gap:8px; flex-shrink:0}
    .mini{display:flex}
    .mini .track{flex:1; min-width:0}
    .icon-btn svg{display:block}
    .icon-btn{
      width:36px; height:36px; border-radius:12px; display:grid; place-items:center; background:#1b1c1f; border:none; color:#fff; cursor:pointer;
    }
    /* Equalizer bars */
    .eq{display:flex; align-items:flex-end; gap:3px; height:22px}
    .bar{width:3px; background:var(--accent); height:4px; border-radius:2px}
    /* Toast */
    .toast{
      position:fixed; right:14px; bottom:80px; background:#16171a; color:#fff; padding:10px 12px; border-radius:12px;
      box-shadow:0 10px 25px rgba(0,0,0,.4); opacity:0; transform:translateY(10px);
      transition: all .25s ease; pointer-events:none; border:1px solid #22242a;
    }
    .toast.show{opacity:1; transform:translateY(0)}
    footer{
      display:flex; align-items:center; justify-content:center; gap:8px; padding:8px; color:var(--muted); font-size:12px;
    }
    .pro{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#1a1b1e; border:1px solid #23262d}
    .pro img{width:16px; height:16px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header><div class="title">RADIO</div>
    <button id="sleepBtn" class="moon" title="Temporizador 30 min">
      <!-- moon svg -->
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true"><defs><radialGradient id="g" cx="50%" cy="40%" r="70%"><stop offset="0%" stop-color="#ffffff" stop-opacity=".22"/><stop offset="100%" stop-color="#ffffff" stop-opacity="0"/></radialGradient></defs><path d="M21 14.5A9 9 0 0 1 9.5 3a7.8 7.8 0 1 0 11.5 11.5Z" stroke="#cfcfcf" stroke-width="1.3" fill="url(#g)" opacity=".9"/></svg>
      <div class="ring">
        <svg width="64" height="64"><circle cx="32" cy="32" r="30"></circle></svg>
      </div>
    </button>
  </header>

  <div id="onAirTop" class="onair-top hidden center">
    <span class="dot"></span><span>ON AIR</span>
  </div>


  <div id="stations" class="stations"></div>

  <div class="now">
    <div class="meta">
      <div id="track" class="track">—</div>
      <div id="stationLabel" class="station">Elegí una estación</div>
    </div>
    <div class="eq" aria-hidden="true">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
  </div>

  <div class="mini">
    <div class="track" id="miniLabel">—</div>
    <div class="controls">
      <button id="prevBtn" class="icon-btn" aria-label="Prev">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#ffffff" d="M6 6h2v12H6zm3 6l9 6V6z"/></svg>
      </button>
      <button id="playPause" class="icon-btn" aria-label="Play/Pause">
        <svg id="ppPlay" class="ppicon" width="20" height="20" viewBox="0 0 24 24"><path fill="#ffffff" d="M8 5v14l11-7z"/></svg>
        <svg id="ppPause" class="ppicon hidden" width="20" height="20" viewBox="0 0 24 24"><path fill="#ffffff" d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>
      </button>
      <button id="stopBtn" class="icon-btn" aria-label="Stop"><svg width="18" height="18" viewBox="0 0 24 24"><path fill="#ffffff" d="M6 6h12v12H6z"/></svg></button>
      <button id="nextBtn" class="icon-btn" aria-label="Next"><svg width="18" height="18" viewBox="0 0 24 24"><path fill="#ffffff" d="M8 18l9-6-9-6v12zm10 0h-2V6h2v12z"/></svg></button>
      <button id="muteBtn" class="icon-btn" aria-label="Mute"><svg width="18" height="18" viewBox="0 0 24 24"><path fill="#ffffff" d="M5 9v6h4l5 5V4L9 9H5z"/></svg></button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <audio id="player" crossorigin="anonymous"></audio>

  <script>
  const STATIONS = [
    { id:'now',   name:'Now 97.9',  url:'https://ipanel.instream.audio:7002/stream', meta:{} },
    { id:'blue',  name:'Blue 100.7',url:'https://27693.live.streamtheworld.com/BLUE_FM_100_7AAC.aac', meta:{ tmwId: 'BLUE_FM_100_7' } },
    { id:'aspen', name:'Aspen 102.3',url:'https://playerservices.streamtheworld.com/api/livestream-redirect/ASPEN.mp3', meta:{ tmwId: 'ASPEN' } },
    { id:'lnp',   name:'LN+ 104.9', url:'https://stream.radio.co/s2ed3bec0a/listen', meta:{} },
  ];
  // Helpers for StreamTheWorld "now playing" fallback (best-effort; CORS may apply)
  async function fetchStreamTheWorldNowPlaying(id){
    // common pattern: https://np.tritondigital.com/public/nowplaying?mountName=ASPEN&... or metadata/nowplaying
    // We'll try a generic endpoint used by many TMW stations:
    const endpoints = [
      `https://np.tritondigital.com/public/nowplaying?mountName=${encodeURIComponent(id)}&numberOfTracks=1&eventType=track`,
      `https://playerservices.streamtheworld.com/api/livestream-redirect/${encodeURIComponent(id)}_SC`
    ];
    for (const url of endpoints){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if (!res.ok) continue;
        const ct = res.headers.get('content-type')||'';
        if (ct.includes('application/json')){
          const j = await res.json();
          const t = j?.nowplaying?.track?.song || j?.song || j?.title;
          if (t) return t;
        } else {
          const txt = await res.text();
          const m = txt.match(/StreamTitle='([^']+)'/);
          if (m) return m[1];
        }
      }catch(e){ /* ignore */ }
    }
    return null;
  }

  // UI
  const stationsEl = document.getElementById('stations');
  const player = document.getElementById('player');
  const pp = document.getElementById('pp');
  const playPause = document.getElementById('playPause');
  const stopBtn = document.getElementById('stopBtn');
  const trackEl = document.getElementById('track');
  const stationLabel = document.getElementById('stationLabel');
  const miniLabel = document.getElementById('miniLabel');
  const toast = document.getElementById('toast');
  const sleepBtn = document.getElementById('sleepBtn');
  const onAirTop = document.getElementById('onAirTop');
  const ppPlay = document.getElementById('ppPlay');
  const ppPause = document.getElementById('ppPause');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const muteBtn = document.getElementById('muteBtn');
  const ring = sleepBtn.querySelector('.ring circle');

  let current = null;
  let index = 0;
  let context, analyser, dataArray, rafId;
  let sleepTimer = null;
  let sleepRemaining = 0; // seconds
  const SLEEP_TOTAL = 30*60; // 30 minutes

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 2200);
  }

  function buildStations(){
    stationsEl.innerHTML = '';
    STATIONS.forEach((s,i)=>{
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.dataset.id = s.id;
      const left = document.createElement('div'); left.className='left';
      const playIc = document.createElement('div'); playIc.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="#ffffff" d="M8 5v14l11-7z"/></svg>';
      left.appendChild(playIc);
      btn.appendChild(left);
      const chip = document.createElement('div'); chip.className='chip'; chip.innerHTML='&nbsp;';
      btn.appendChild(chip);
      btn.addEventListener('click', ()=> playStation(s));
      stationsEl.appendChild(btn);
    });
  }

  async function playStation(s){
    index = STATIONS.findIndex(x=>x.id===s.id);
    current = s;
    player.src = s.url + (s.url.includes('?') ? '&' : '?') + 't=' + Date.now(); // bust cache
    player.play().catch(()=>{});
    ppPlay.classList.add('hidden'); ppPause.classList.remove('hidden');
    stationLabel.textContent = s.name;
    miniLabel.textContent = s.name;
    trackEl.textContent = 'Cargando…';
    showToast('Reproduciendo ' + s.name);
    onAirTop.classList.remove('hidden');
    updateMetadata();
    if (!context) initAnalyser();
  }

  function initAnalyser(){
    try{
      context = new (window.AudioContext || window.webkitAudioContext)();
      const source = context.createMediaElementSource(player);
      analyser = context.createAnalyser();
      analyser.fftSize = 256;
      source.connect(analyser);
      analyser.connect(context.destination);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      animateEq();
    }catch(e){ /* likely due to CORS or autoplay policy; silently ignore */ }
  }

  function animateEq(){
    const bars = document.querySelectorAll('.bar');
    const len = bars.length;
    const step = ()=>{
      if (analyser){
        analyser.getByteFrequencyData(dataArray);
        for(let i=0;i<len;i++){
          const idx = (i*2+5)|0;
          const v = dataArray[idx] || 0;
          const h = 4 + (v/255)*18; // keep small per request
          bars[i].style.height = h + 'px';
        }
      } else {
        // fallback idle animation
        const t = Date.now()/200;
        for(let i=0;i<len;i++){
          const h = 4 + (Math.sin(t+i)*0.5+0.5)*18;
          bars[i].style.height = h + 'px';
        }
      }
      rafId = requestAnimationFrame(step);
    };
    step();
  }

  async function updateMetadata(){
    // Try StreamTheWorld helper when id present
    let title = null;
    if (current?.meta?.tmwId){
      title = await fetchStreamTheWorldNowPlaying(current.meta.tmwId);
    }
    // Fallback to mediaSession metadata if set externally
    if (!title && 'mediaSession' in navigator){
      const md = navigator.mediaSession.metadata;
      if (md && (md.title || md.artist)){
        title = [md.title, md.artist].filter(Boolean).join(' — ');
      }
    }
    trackEl.textContent = title || 'Reproduciendo…';
    if (title) miniLabel.textContent = `${current.name} · ${title}`;
  }

  // Controls
  playPause.addEventListener('click', ()=>{
    if (player.paused){ player.play(); ppPlay.classList.add('hidden'); ppPause.classList.remove('hidden'); showToast('Play'); }
    else { player.pause(); ppPause.classList.add('hidden'); ppPlay.classList.remove('hidden'); showToast('Pausa'); }
  });
  prevBtn.addEventListener('click', ()=>{
    index = (index - 1 + STATIONS.length) % STATIONS.length;
    playStation(STATIONS[index]);
  });
  nextBtn.addEventListener('click', ()=>{
    index = (index + 1) % STATIONS.length;
    playStation(STATIONS[index]);
  });
  muteBtn.addEventListener('click', ()=>{
    player.muted = !player.muted;
    showToast(player.muted? 'Mute' : 'Unmute');
  });

  stopBtn.addEventListener('click', ()=>{
    player.pause(); player.src=''; ppPause.classList.add('hidden'); ppPlay.classList.remove('hidden'); showToast('Stop');
  });
  player.addEventListener('playing', updateMetadata);
  setInterval(()=>{ if(!player.paused) updateMetadata(); }, 15000);

  // Sleep timer (30 min)
  function updateRing(){
    const ratio = Math.max(0, Math.min(1, sleepRemaining / SLEEP_TOTAL));
    const circumference = 2*Math.PI*30;
    ring.style.strokeDashoffset = String(circumference * (1 - ratio));
  }
  function startSleep(){
    sleepRemaining = SLEEP_TOTAL;
    sleepBtn.classList.add('active');
    updateRing();
    if (sleepTimer) clearInterval(sleepTimer);
    sleepTimer = setInterval(()=>{
      sleepRemaining -= 1; updateRing();
      if (sleepRemaining <= 0){
        clearInterval(sleepTimer); sleepTimer=null;
        player.pause(); pp.textContent='▶';
        sleepBtn.classList.remove('active');
        ring.style.strokeDashoffset = String(2*Math.PI*22);
        showToast('Temporizador: fin');
      }
    }, 1000);
    showToast('Temporizador: 30 min');
  }
  function stopSleep(){
    if (sleepTimer){ clearInterval(sleepTimer); sleepTimer=null; }
    sleepBtn.classList.remove('active');
    ring.style.strokeDashoffset = String(2*Math.PI*22);
    showToast('Temporizador cancelado');
  }
  sleepBtn.addEventListener('click', ()=>{
    if (sleepTimer) stopSleep(); else startSleep();
  });

  // PWA install prompt helper
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt = e;
    showToast('Instalable: abre el menú y “Agregar a inicio”');
  });
  window.addEventListener('appinstalled', ()=> showToast('App instalada'));

  // Build UI & default play first
  buildStations();
  </script>
</body>
</html>
